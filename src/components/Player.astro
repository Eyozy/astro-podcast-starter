---
import episodes from "../data/episodes.json";
import site from "../data/site.json";

// 仅提取播放所需的最小数据，减少 HTML 内联体积
const minimalEpisodes = episodes.map((ep) => ({
  id: ep.id,
  title: ep.title,
  audioUrl: ep.enclosure?.url,
  cover: ep.itunes?.image,
}));
---

<div
  id="global-player"
  transition:persist
  class="fixed bottom-4 right-4 z-50 transition-all duration-500 opacity-0 scale-0 pointer-events-none sm:bottom-8 sm:right-8"
>
  <!-- 最小化后的悬浮球 -->
  <button
    id="player-minimized-ball"
    class="absolute bottom-0 right-0 z-20 w-10 h-10 sm:w-12 sm:h-12 bg-[#2d2a26] text-white rounded-full shadow-2xl flex items-center justify-center hover:scale-110 active:scale-95 group overflow-hidden border-2 border-white/20 transition-all duration-500 cubic-bezier(0.34, 1.56, 0.64, 1) origin-bottom-right opacity-0 scale-0 pointer-events-none translate-y-10"
    aria-label={site.player.expandLabel}
  >
    <!-- 封面背景 -->
    <img
      id="player-min-cover"
      src={site.assets.defaultCover}
      alt=""
      class="absolute inset-0 w-full h-full object-cover opacity-40 group-hover:opacity-60 transition-opacity"
    />
    <div
      class="absolute inset-0 bg-black/20 group-hover:bg-black/40 transition-colors"
    >
    </div>

    <!-- 进度环 -->
    <svg
      class="absolute inset-0 w-full h-full -rotate-90 scale-[1.05]"
      viewBox="0 0 100 100"
    >
      <circle
        cx="50"
        cy="50"
        r="48"
        stroke="rgba(255,255,255,0.1)"
        stroke-width="2"
        fill="none"></circle>
      <circle
        id="progress-ring"
        cx="50"
        cy="50"
        r="48"
        stroke="currentColor"
        stroke-width="3"
        fill="none"
        stroke-dasharray="301.5"
        stroke-dashoffset="301.5"
        class="text-orange-500 transition-all duration-300"></circle>
    </svg>

    <div
      id="min-play-icon"
      class="relative z-10 transition-transform group-hover:scale-110 drop-shadow-md"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="size-4 sm:size-5"
        viewBox="0 0 24 24"
        fill="currentColor"
      >
        <path
          d="M7 4.406c0-.853.947-1.354 1.649-.865l10.211 7.112c.621.432.621 1.34 0 1.772l-10.211 7.112c-.702.489-1.649-.012-1.649-.865V4.406z"
        ></path>
      </svg>
    </div>
    <div
      id="min-pause-icon"
      class="relative z-10 hidden transition-transform group-hover:scale-110 drop-shadow-md"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="size-4 sm:size-5"
        fill="currentColor"
        viewBox="0 0 24 24"
      >
        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path>
      </svg>
    </div>
  </button>

  <!-- 展开后的播放器卡片 -->
  <div
    id="player-expanded-card"
    class="absolute bottom-0 right-0 z-10 w-[calc(100vw-3rem)] sm:w-90 md:w-105 lg:w-120 border border-[#2d2a26]/20 shadow-[0_20px_50px_rgba(0,0,0,0.15)] rounded-2xl overflow-hidden flex flex-col backdrop-blur-xl bg-white/95 transition-all duration-500 cubic-bezier(0.34, 1.56, 0.64, 1) origin-bottom-right"
  >
    <!-- 顶部拖拽/控制栏 -->
    <div
      class="px-4 py-2 bg-[#f5f2ed] border-b border-[#2d2a26]/10 flex justify-between items-center cursor-move"
    >
      <span
        class="text-[10px] font-serif font-bold uppercase tracking-tighter opacity-40"
        >{site.player.nowPlayingLabel}</span
      >
      <div class="flex items-center gap-1">
        <button
          id="player-minimize-btn"
          class="p-1 hover:bg-[#2d2a26]/5 rounded-lg transition-colors"
          title={site.player.minimizeLabel}
          aria-label={site.player.minimizeAriaLabel}
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="size-4 sm:size-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>
        <button
          id="player-close-btn"
          class="p-1 hover:bg-red-50 hover:text-red-600 rounded-lg transition-colors"
          title={site.player.closeLabel}
          aria-label={site.player.closeAriaLabel}
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="size-4 sm:size-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>

    <div class="p-5">
      <div class="flex gap-4 mb-6">
        <!-- 封面图 -->
        <div
          class="w-20 h-20 shrink-0 rounded-xl overflow-hidden border border-[#2d2a26]/10 shadow-inner bg-[#f0ede8]"
        >
          <img
            id="player-cover"
            src={site.assets.defaultCover}
            alt="Cover"
            class="w-full h-full object-cover"
          />
        </div>

        <!-- 标题信息 -->
        <div class="grow min-w-0 flex flex-col justify-center">
          <h3
            id="player-title"
            class="text-base font-bold leading-tight mb-1 truncate"
          >
            {site.player.notPlayingLabel}
          </h3>
          <p class="text-xs opacity-50 font-serif">{site.brand.name}</p>
        </div>
      </div>

      <!-- 进度条 -->
      <div class="mb-6 select-none">
        <div
          class="flex justify-between text-[10px] font-serif opacity-40 mb-1.5"
        >
          <span id="player-current-time">00:00</span>
          <span id="player-duration">00:00</span>
        </div>
        <div
          class="group h-3 -my-1 py-1 cursor-pointer"
          id="progress-container"
          role="slider"
          tabindex="0"
          aria-label="播放进度"
          aria-valuemin="0"
          aria-valuemax="100"
          aria-valuenow="0"
          aria-valuetext="00:00"
        >
          <div
            class="h-1.5 bg-[#2d2a26]/5 rounded-full relative overflow-visible"
          >
            <div
              id="progress-bar"
              class="absolute top-0 left-0 h-full bg-orange-700 rounded-full w-0 pointer-events-none"
            >
            </div>
            <div
              id="progress-handle"
              class="absolute top-1/2 -translate-y-1/2 -ml-1 w-3 h-3 bg-orange-700 rounded-full border-2 border-white shadow-md opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none scale-0 group-hover:scale-100"
            >
            </div>
          </div>
        </div>
      </div>

      <!-- 主控制按钮 -->
      <div class="flex items-center justify-between px-2">
        <button
          id="player-prev"
          class="p-2 text-[#2d2a26] opacity-40 hover:opacity-100 disabled:opacity-10 transition-all"
          title={site.player.prevLabel}
          aria-label={site.player.prevLabel}
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="size-5 sm:size-6"
            fill="currentColor"
            viewBox="0 0 24 24"
            ><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"></path></svg
          >
        </button>

        <div class="flex items-center gap-4">
          <button
            id="player-backward"
            class="p-2 text-[#2d2a26] opacity-40 hover:opacity-100 transition-all"
            title={site.player.backwardLabel}
            aria-label={site.player.backwardLabel}
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="size-5 sm:size-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.334 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z"
              ></path></svg
            >
          </button>

          <button
            id="player-play-pause"
            class="w-14 h-14 bg-[#2d2a26] text-white rounded-full flex items-center justify-center hover:bg-orange-800 transition-all shadow-xl hover:scale-105 active:scale-95"
            aria-label={site.player.playAriaLabel}
            aria-pressed="false"
          >
            <svg
              id="play-icon"
              xmlns="http://www.w3.org/2000/svg"
              class="size-6 sm:size-7"
              viewBox="0 0 24 24"
              fill="currentColor"
            >
              <path
                d="M7 4.406c0-.853.947-1.354 1.649-.865l10.211 7.112c.621.432.621 1.34 0 1.772l-10.211 7.112c-.702.489-1.649-.012-1.649-.865V4.406z"
              ></path>
            </svg>
            <svg
              id="pause-icon"
              xmlns="http://www.w3.org/2000/svg"
              class="size-6 sm:size-7 hidden"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path>
            </svg>
          </button>

          <button
            id="player-forward"
            class="p-2 text-[#2d2a26] opacity-40 hover:opacity-100 transition-all"
            title={site.player.forwardLabel}
            aria-label={site.player.forwardLabel}
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="size-5 sm:size-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              ><path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11.933 12.8a1 1 0 000-1.6l-5.333-4A1 1 0 005 8v8a1 1 0 001.6.8l5.333-4zM19.933 12.8a1 1 0 000-1.6l-5.333-4A1 1 0 0013 8v8a1 1 0 001.6.8l5.333-4z"
              ></path></svg
            >
          </button>
        </div>

        <button
          id="player-next"
          class="p-2 text-[#2d2a26] opacity-40 hover:opacity-100 disabled:opacity-10 transition-all"
          title={site.player.nextLabel}
          aria-label={site.player.nextLabel}
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="size-5 sm:size-6"
            fill="currentColor"
            viewBox="0 0 24 24"
            ><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"></path></svg
          >
        </button>
      </div>
    </div>
  </div>

  <audio id="main-audio" src="" preload="auto"></audio>
</div>

<script
  define:vars={{
    allEpisodes: minimalEpisodes,
    defaultCover: site.assets.defaultCover,
    playAriaLabel: site.player.playAriaLabel,
    pauseAriaLabel: site.player.pauseAriaLabel,
  }}
>
  let isMinimized = false;
  let isDragging = false;
  let currentEpisodeIndex = -1;
  const preloadCache = new Set();
  const SEEK_SECONDS = 15;
  const PROGRESS_CIRCUMFERENCE = 301.5;

  // 公共样式类常量
  const HIDDEN_CLASSES = [
    "scale-0",
    "opacity-0",
    "pointer-events-none",
    "translate-y-10",
  ];
  const VISIBLE_CLASSES = [
    "scale-100",
    "opacity-100",
    "pointer-events-auto",
    "translate-y-0",
  ];
  const PLAYER_HIDDEN = ["opacity-0", "scale-0", "pointer-events-none"];
  const PLAYER_VISIBLE = ["opacity-100", "scale-100", "pointer-events-auto"];

  // 辅助函数：切换元素可见性
  function setElementVisible(el, visible) {
    if (!el) return;
    if (visible) {
      el.classList.remove(...HIDDEN_CLASSES);
      el.classList.add(...VISIBLE_CLASSES);
    } else {
      el.classList.add(...HIDDEN_CLASSES);
      el.classList.remove(...VISIBLE_CLASSES);
    }
  }

  function setPlayerVisible(container, visible) {
    if (!container) return;
    if (visible) {
      container.classList.remove(...PLAYER_HIDDEN);
      container.classList.add(...PLAYER_VISIBLE);
    } else {
      container.classList.add(...PLAYER_HIDDEN);
      container.classList.remove(...PLAYER_VISIBLE);
    }
  }

  function getPlayerElements() {
    return {
      playerContainer: document.getElementById("global-player"),
      expandedCard: document.getElementById("player-expanded-card"),
      minimizedBall: document.getElementById("player-minimized-ball"),
      audio: document.getElementById("main-audio"),
      playPauseBtn: document.getElementById("player-play-pause"),
      playIcon: document.getElementById("play-icon"),
      pauseIcon: document.getElementById("pause-icon"),
      titleEl: document.getElementById("player-title"),
      coverEl: document.getElementById("player-cover"),
      currentTimeEl: document.getElementById("player-current-time"),
      durationEl: document.getElementById("player-duration"),
      progressBar: document.getElementById("progress-bar"),
      progressContainer: document.getElementById("progress-container"),
      progressHandle: document.getElementById("progress-handle"),
      closeBtn: document.getElementById("player-close-btn"),
      minimizeBtn: document.getElementById("player-minimize-btn"),
      forwardBtn: document.getElementById("player-forward"),
      backwardBtn: document.getElementById("player-backward"),
      nextBtn: document.getElementById("player-next"),
      prevBtn: document.getElementById("player-prev"),
      progressRing: document.getElementById("progress-ring"),
      minPlayIcon: document.getElementById("min-play-icon"),
      minPauseIcon: document.getElementById("min-pause-icon"),
      minCoverEl: document.getElementById("player-min-cover"),
    };
  }

  function preloadAudio(url) {
    if (!url || preloadCache.has(url)) return;

    // 使用临时音频对象触发 DNS 解析 + 预缓存
    const tempAudio = new Audio();
    tempAudio.preload = "auto";
    tempAudio.src = url;
    preloadCache.add(url);
  }

  function setEpisodeUI(elements, episode, coverOverride) {
    const coverImage = coverOverride || episode.cover || defaultCover;
    if (elements.audio) elements.audio.src = episode.audioUrl;
    if (elements.titleEl) elements.titleEl.textContent = episode.title;
    if (elements.coverEl) elements.coverEl.src = coverImage;
    if (elements.minCoverEl) elements.minCoverEl.src = coverImage;
  }

  function initPlayer() {
    const elements = getPlayerElements();
    const {
      playerContainer,
      expandedCard,
      minimizedBall,
      audio,
      playPauseBtn,
      playIcon,
      pauseIcon,
      titleEl,
      coverEl,
      currentTimeEl,
      durationEl,
      progressBar,
      progressContainer,
      progressHandle,
      closeBtn,
      minimizeBtn,
      forwardBtn,
      backwardBtn,
      nextBtn,
      prevBtn,
      progressRing,
      minPlayIcon,
      minPauseIcon,
      minCoverEl,
    } = elements;

    if (!audio) return;

    // 悬停/触摸预加载，缩短首播等待时间
    document.querySelectorAll(".play-button").forEach((btn) => {
      btn.addEventListener("mouseenter", () => {
        const url = btn.getAttribute("data-audio");
        if (url) preloadAudio(url);
      });
      btn.addEventListener(
        "touchstart",
        () => {
          const url = btn.getAttribute("data-audio");
          if (url) preloadAudio(url);
        },
        { passive: true },
      );
    });

    // Draggable Progress Logic
    function updateProgressVisual(percent) {
      if (progressBar) progressBar.style.width = `${percent}%`;
      if (progressHandle) {
        progressHandle.style.left = `${percent}%`;
        progressHandle.classList.add("opacity-100", "scale-100"); // Force visible when dragging
      }
    }

    function handleSeekInteraction(e) {
      if (!progressContainer) return 0;
      const rect = progressContainer.getBoundingClientRect();
      let pos = (e.clientX - rect.left) / rect.width;
      pos = Math.max(0, Math.min(1, pos));
      return pos;
    }

    // 命名函数用于 document 级别事件监听器，便于清理
    function handleDocMouseMove(e) {
      if (!isDragging) return;
      e.preventDefault();
      const pos = handleSeekInteraction(e);
      updateProgressVisual(pos * 100);

      // Optional: Live update time text while dragging
      if (currentTimeEl && audio.duration) {
        currentTimeEl.textContent = formatTime(pos * audio.duration);
      }
    }

    function handleDocMouseUp(e) {
      if (!isDragging) return;
      isDragging = false;
      const pos = handleSeekInteraction(e);
      if (audio.duration) {
        audio.currentTime = pos * audio.duration;
      }
      if (progressHandle) {
        progressHandle.classList.remove("opacity-100", "scale-100"); // Revert to hover-only unless hovering
      }
    }

    // 触摸事件处理（移动端支持）
    function handleTouchStart(e) {
      isDragging = true;
      const touch = e.touches[0];
      const pos = handleSeekInteraction({ clientX: touch.clientX });
      updateProgressVisual(pos * 100);
    }

    function handleDocTouchMove(e) {
      if (!isDragging) return;
      const touch = e.touches[0];
      const pos = handleSeekInteraction({ clientX: touch.clientX });
      updateProgressVisual(pos * 100);
      if (currentTimeEl && audio.duration) {
        currentTimeEl.textContent = formatTime(pos * audio.duration);
      }
    }

    function handleDocTouchEnd(e) {
      if (!isDragging || !progressContainer) return;
      isDragging = false;
      // 使用最后的触摸位置
      const rect = progressContainer.getBoundingClientRect();
      const lastTouch = e.changedTouches[0];
      let pos = (lastTouch.clientX - rect.left) / rect.width;
      pos = Math.max(0, Math.min(1, pos));
      if (audio.duration) {
        audio.currentTime = pos * audio.duration;
      }
      if (progressHandle) {
        progressHandle.classList.remove("opacity-100", "scale-100");
      }
    }

    progressContainer?.addEventListener("mousedown", (e) => {
      isDragging = true;
      const pos = handleSeekInteraction(e);
      updateProgressVisual(pos * 100);
    });

    progressContainer?.addEventListener("touchstart", handleTouchStart, {
      passive: true,
    });

    // 进度条键盘事件支持（无障碍）
    progressContainer?.addEventListener("keydown", (e) => {
      if (!audio.duration) return;
      const KEYBOARD_SEEK_SECONDS = 5;
      if (e.key === "ArrowLeft") {
        e.preventDefault();
        audio.currentTime = Math.max(
          0,
          audio.currentTime - KEYBOARD_SEEK_SECONDS,
        );
      } else if (e.key === "ArrowRight") {
        e.preventDefault();
        audio.currentTime = Math.min(
          audio.duration,
          audio.currentTime + KEYBOARD_SEEK_SECONDS,
        );
      }
    });

    // 移除旧监听器再添加新的，防止 View Transitions 导致重复绑定
    document.removeEventListener("mousemove", handleDocMouseMove);
    document.removeEventListener("mouseup", handleDocMouseUp);
    document.removeEventListener("touchmove", handleDocTouchMove);
    document.removeEventListener("touchend", handleDocTouchEnd);

    document.addEventListener("mousemove", handleDocMouseMove);
    document.addEventListener("mouseup", handleDocMouseUp);
    document.addEventListener("touchmove", handleDocTouchMove, {
      passive: true,
    });
    document.addEventListener("touchend", handleDocTouchEnd);

    // 页面切换前清理事件监听器
    document.addEventListener(
      "astro:before-swap",
      () => {
        document.removeEventListener("mousemove", handleDocMouseMove);
        document.removeEventListener("mouseup", handleDocMouseUp);
        document.removeEventListener("touchmove", handleDocTouchMove);
        document.removeEventListener("touchend", handleDocTouchEnd);
      },
      { once: true },
    );

    if (audio.dataset.initialized) {
      updateNavButtons();
      return;
    }
    audio.dataset.initialized = "true";

    function formatTime(seconds) {
      if (isNaN(seconds)) return "00:00";
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      return [h > 0 ? h : null, m, s]
        .filter((x) => x !== null)
        .map((x) => x.toString().padStart(2, "0"))
        .join(":");
    }

    function updatePlayState() {
      const isPaused = audio.paused;
      if (playPauseBtn) {
        playPauseBtn.setAttribute("aria-pressed", (!isPaused).toString());
        playPauseBtn.setAttribute(
          "aria-label",
          isPaused ? playAriaLabel : pauseAriaLabel,
        );
      }
      // Expanded state
      if (isPaused) {
        playIcon?.classList.remove("hidden");
        pauseIcon?.classList.add("hidden");
        minPlayIcon?.classList.remove("hidden");
        minPauseIcon?.classList.add("hidden");
      } else {
        playIcon?.classList.add("hidden");
        pauseIcon?.classList.remove("hidden");
        minPlayIcon?.classList.add("hidden");
        minPauseIcon?.classList.remove("hidden");
      }
    }

    function playEpisode(index) {
      if (index < 0 || index >= allEpisodes.length) return;

      const ep = allEpisodes[index];

      // If same episode and just paused, then play
      if (currentEpisodeIndex === index && audio.src === ep.enclosure?.url) {
        audio.play();
        updatePlayState();
        return;
      }

      currentEpisodeIndex = index;
      setEpisodeUI(elements, ep);

      // Show player
      setPlayerVisible(playerContainer, true);
      // Ensure expanded when starting new playback
      toggleMinimize(false);

      audio.play().catch((e) => console.log("Auto-play blocked or failed", e));
      updatePlayState();
      updateNavButtons();
    }

    function updateNavButtons() {
      if (prevBtn) prevBtn.disabled = currentEpisodeIndex <= 0;
      if (nextBtn)
        nextBtn.disabled = currentEpisodeIndex >= allEpisodes.length - 1;
    }

    // Toggle Minimize
    function toggleMinimize(min) {
      isMinimized = min;
      setElementVisible(expandedCard, !isMinimized);
      setElementVisible(minimizedBall, isMinimized);
    }

    // --- Listeners ---
    playPauseBtn?.addEventListener("click", () => {
      if (audio.paused) audio.play();
      else audio.pause();
      updatePlayState();
    });

    minimizedBall?.addEventListener("click", () => toggleMinimize(false));

    forwardBtn?.addEventListener(
      "click",
      () => (audio.currentTime += SEEK_SECONDS),
    );
    backwardBtn?.addEventListener(
      "click",
      () => (audio.currentTime -= SEEK_SECONDS),
    );
    prevBtn?.addEventListener("click", () =>
      playEpisode(currentEpisodeIndex - 1),
    );
    nextBtn?.addEventListener("click", () =>
      playEpisode(currentEpisodeIndex + 1),
    );

    closeBtn?.addEventListener("click", () => {
      audio.pause();
      audio.src = "";
      setPlayerVisible(playerContainer, false);
      currentEpisodeIndex = -1;
    });

    minimizeBtn?.addEventListener("click", (e) => {
      e.stopPropagation();
      toggleMinimize(true);
    });

    audio.addEventListener("timeupdate", () => {
      if (isDragging) return; // Skip updates while dragging

      const percent = (audio.currentTime / audio.duration) * 100;
      if (progressBar) progressBar.style.width = `${percent}%`;
      if (progressHandle) progressHandle.style.left = `${percent}%`;
      if (currentTimeEl)
        currentTimeEl.textContent = formatTime(audio.currentTime);

      // 更新进度条 ARIA 属性
      if (progressContainer) {
        progressContainer.setAttribute(
          "aria-valuenow",
          Math.round(percent).toString(),
        );
        progressContainer.setAttribute(
          "aria-valuetext",
          formatTime(audio.currentTime),
        );
      }

      // Update minimized ring
      if (progressRing) {
        const offset =
          PROGRESS_CIRCUMFERENCE - (percent / 100) * PROGRESS_CIRCUMFERENCE;
        progressRing.style.strokeDashoffset = offset.toString();
      }
    });

    audio.addEventListener("loadedmetadata", () => {
      if (durationEl) durationEl.textContent = formatTime(audio.duration);
    });

    // 音频加载错误处理
    audio.addEventListener("error", () => {
      console.error("音频加载失败:", audio.error);
      if (titleEl) titleEl.textContent = "加载失败，请重试";
      updatePlayState();
    });

    audio.addEventListener("stalled", () => {
      console.warn("音频缓冲中...");
    });

    audio.addEventListener("play", updatePlayState);
    audio.addEventListener("pause", updatePlayState);
    audio.addEventListener("ended", () => {
      if (currentEpisodeIndex < allEpisodes.length - 1) {
        playEpisode(currentEpisodeIndex + 1);
      }
    });

    // Note: click listener on progress container is removed as mousedown+mouseup handles it

    // Global seek function
    window.seekToTimestamp = function (seconds, audioUrl, title, cover) {
      const url = audioUrl;
      if (!url) return;

      const idx = allEpisodes.findIndex((ep) => ep.audioUrl === url);

      if (idx !== -1) {
        const ep = allEpisodes[idx];

        if (currentEpisodeIndex === idx && audio.src === url) {
          audio.currentTime = seconds;
          if (audio.paused) audio.play();
        } else {
          currentEpisodeIndex = idx;
          setEpisodeUI(elements, ep, cover);

          // Show player
          setPlayerVisible(playerContainer, true);
          toggleMinimize(false);

          audio
            .play()
            .then(() => {
              audio.currentTime = seconds;
            })
            .catch((e) => console.log("Play failed", e));
          updatePlayState();
          updateNavButtons();
        }
      }
    };
  }

  // View Transitions support
  document.addEventListener("astro:page-load", initPlayer);

  // Listen for global play clicks
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".play-button");
    if (!btn) return;

    const url = btn.getAttribute("data-audio");
    const cover = btn.getAttribute("data-cover");
    const idx = allEpisodes.findIndex((ep) => ep.audioUrl === url);
    if (idx === -1) return;

    const elements = getPlayerElements();
    const { playerContainer, expandedCard, minimizedBall, audio } = elements;
    if (!audio) return;

    const ep = allEpisodes[idx];
    currentEpisodeIndex = idx;
    setEpisodeUI(elements, ep, cover);

    // Show player and expand
    setPlayerVisible(playerContainer, true);
    setElementVisible(expandedCard, true);
    setElementVisible(minimizedBall, false);
    isMinimized = false;

    audio
      .play()
      .catch((err) => console.log("Auto-play blocked or failed", err));
  });

  // 键盘事件支持（无障碍）- Enter 和 Space 触发播放
  document.addEventListener("keydown", (e) => {
    if (e.key !== "Enter" && e.key !== " ") return;
    const btn = e.target.closest(".play-button");
    if (!btn) return;

    e.preventDefault();
    btn.click(); // 复用点击处理逻辑
  });
</script>
