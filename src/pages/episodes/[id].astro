---
import MainLayout from "../../layouts/MainLayout.astro";
import episodes from "../../data/episodes.json";
import { getEntry } from "astro:content";
import DOMPurify from "isomorphic-dompurify";
// 详情页文案在 site.json 的 pages.episodeDetail 中配置。
import site from "../../data/site.json";

export async function getStaticPaths() {
  return episodes.map((episode) => ({
    params: { id: episode.id },
    props: { episode },
  }));
}

const { episode } = Astro.props;
const { id } = Astro.params;

const date = new Date(episode.pubDate);
const formattedDate = date.toLocaleDateString("zh-CN", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

// 封面图可能为空，使用统一默认值兜底
const coverImage = episode.itunes?.image || site.assets.defaultCover;

// Format duration
const duration = episode.itunes?.duration || site.ui.unknownDurationLabel;
const episodeNumber =
  (episode.itunes as any)?.episode || site.ui.episodeNumberFallbackLabel;
const episodeNumberLabel = `${site.ui.episodeNumberPrefix} ${episodeNumber}`;

// Try to get transcript
let transcript;
let TranscriptContent;
try {
  transcript = await getEntry("transcripts", episode.id);
  if (transcript) {
    const rendered = await transcript.render();
    TranscriptContent = rendered.Content;
  }
} catch (e) {
  console.log(`No transcript found for episode ${episode.id}`);
}

// 安全清理 RSS 内容，防止 XSS 攻击
const sanitizedContent = DOMPurify.sanitize(episode.content || "", {
  ALLOWED_TAGS: [
    "p", "br", "strong", "em", "a", "ul", "ol", "li",
    "h2", "h3", "img", "figure", "figcaption", "blockquote",
  ],
  ALLOWED_ATTR: ["href", "src", "alt", "class"],
  ALLOW_DATA_ATTR: false,
});
---

<MainLayout title={episode.title}>
  <article class="max-w-6xl mx-auto w-full" data-episode-page>
    <!-- Breadcrumbs -->
    <nav class="mb-8 md:mb-12 font-serif text-sm opacity-50">
      <a href="/episodes" class="hover:text-orange-800 transition-colors"
        >{site.pages.episodeDetail.breadcrumbListLabel}</a
      >
      <span class="mx-2">/</span>
      <span class="text-[#2d2a26]">{site.pages.episodeDetail.breadcrumbCurrentLabel}</span>
    </nav>

    <!-- Header Section -->
    <header class="flex flex-col md:flex-row md:items-stretch gap-6 md:gap-8 lg:gap-12 mb-12 md:mb-20">
      <!-- 封面图：移动端隐藏，桌面端显示固定 1:1 比例 -->
      <div
        class="hidden md:block w-60 lg:w-72 shrink-0 shadow-2xl border border-[#2d2a26]/5 overflow-hidden bg-[#f0ede8] rounded-2xl md:aspect-square self-start md:self-stretch"
        data-fit-cover
      >
        <img
          src={coverImage}
          alt={episode.title}
          class="size-full object-cover"
        />
      </div>

      <div
        class="md:hidden w-[clamp(140px,45vw,220px)] mx-auto shadow-lg border border-[#2d2a26]/5 overflow-hidden bg-[#f0ede8] rounded-2xl aspect-square"
      >
        <img
          src={coverImage}
          alt={episode.title}
          class="size-full object-cover"
        />
      </div>

      <div
        class="grow min-w-0 flex flex-col justify-between py-1"
        data-fit-content
      >
        <div>
          <div class="flex items-center gap-3 mb-4">
            <span
              class="text-[10px] font-serif font-bold uppercase tracking-widest text-orange-700 bg-orange-50 px-3 py-1 rounded-md"
            >
              {episodeNumberLabel}
            </span>
            <time class="text-xs font-serif opacity-50">{formattedDate}</time>
          </div>

          <h1
            class="text-2xl md:text-4xl lg:text-5xl font-bold mb-4 leading-tight tracking-tight"
            data-fit-title
            data-min-scale="0.55"
            data-min-font="16"
          >
            {episode.title}
          </h1>

          <!-- Tags -->
          {
            episode.tags && episode.tags.length > 0 && (
              <div class="flex flex-wrap gap-2 mb-4">
                {episode.tags.map((tag) => (
                  <span
                    class="tag-item cursor-pointer text-xs px-3 py-1 bg-[#f5f2ed] border border-[#2d2a26]/10 text-[#2d2a26]/60 rounded-full font-serif hover:bg-orange-50 hover:border-orange-200 hover:text-orange-700 transition-colors"
                    data-tag={tag}
                  >
                    #{tag}
                  </span>
                ))}
              </div>
            )
          }
        </div>

        <div class="flex flex-col gap-4">
          <div
            class="flex flex-wrap items-center gap-x-8 gap-y-2 text-sm font-serif opacity-60"
          >
            <div class="flex items-center gap-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="size-4 sm:size-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              {duration}
            </div>
            <div class="flex items-center gap-2">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="size-4 sm:size-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"
                ></path>
              </svg>
              {episode.enclosure?.type?.split("/")[1]?.toUpperCase() || "MP3"}
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-4">
            <button
              class="play-button flex items-center gap-2.5 px-6 py-3 bg-[#2d2a26] text-white font-serif text-xs font-bold uppercase tracking-widest hover:bg-orange-800 transition-all rounded-lg shadow-lg transform hover:-translate-y-0.5 active:translate-y-0"
              data-title={episode.title}
              data-audio={episode.enclosure?.url}
              data-cover={coverImage}
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="size-2.5 sm:size-3 translate-x-0.5"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path d="M8 5v14l11-7z"></path>
              </svg>
              <span>{site.pages.episodeDetail.playNowLabel}</span>
            </button>

            {
              TranscriptContent && (
                <button
                  id="download-md"
                  class="flex items-center gap-2.5 px-6 py-3 border border-[#2d2a26]/10 font-serif text-xs font-bold uppercase tracking-widest hover:bg-[#2d2a26]/5 transition-all cursor-pointer rounded-lg shadow-sm"
                  title={site.pages.episodeDetail.downloadTranscriptTitle}
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="size-3.5 sm:size-4"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                    />
                  </svg>
                  <span>{site.pages.episodeDetail.downloadTranscriptLabel}</span>
                </button>
              )
            }
          </div>
        </div>
      </div>
    </header>

    <!-- Content Section -->
    <section
      class="prose prose-orange max-w-none prose-headings:font-serif prose-p:font-serif prose-p:leading-relaxed prose-p:text-[#2d2a26]/80 bg-white p-8 md:p-12 lg:p-16 border border-[#2d2a26]/5 shadow-sm rounded-2xl"
    >
      <!-- Tabs Navigation -->
      <div
        class="flex items-center gap-8 border-b border-[#2d2a26]/10 mb-10 pb-4"
      >
        <button
          class="tab-btn active text-lg font-bold font-serif transition-colors text-orange-700 opacity-100"
          type="button"
          data-target="info"
        >
          {site.pages.episodeDetail.infoTabLabel}
        </button>
        <button
          class={`tab-btn text-lg font-bold font-serif transition-all ${!TranscriptContent ? "opacity-30 cursor-not-allowed" : "opacity-40 hover:opacity-100 hover:text-orange-700"}`}
          type="button"
          data-target="transcript"
          disabled={!TranscriptContent}
          title={!TranscriptContent ? site.pages.episodeDetail.transcriptEmptyTitle : ""}
        >
          {site.pages.episodeDetail.transcriptTabLabel}
          {
            TranscriptContent && (
              <span class="ml-2 text-xs bg-orange-100 text-orange-800 px-2 py-0.5 rounded-full font-serif font-bold tracking-wider">
                {site.pages.episodeDetail.transcriptNewBadgeLabel}
              </span>
            )
          }
        </button>
      </div>

      <!-- Episode Info Panel -->
      <div
        id="panel-info"
        class="tab-panel transition-opacity duration-300 ease-in-out"
      >
        <div
          class="episode-content"
          id="episode-body"
          set:html={sanitizedContent}
        />
      </div>

      <!-- Transcript Panel -->
      {
        TranscriptContent && (
          <div
            id="panel-transcript"
            class="tab-panel hidden opacity-0 transition-opacity duration-300 ease-in-out"
          >
            {transcript?.data.contributors && (
              <div class="mb-8 p-4 bg-[#f9f8f6] rounded-lg border border-[#2d2a26]/5">
                <span class="text-xs font-bold uppercase tracking-widest opacity-50 block mb-2">
                  {site.pages.episodeDetail.transcriptContributorsLabel}
                </span>
                <div class="flex flex-wrap gap-2">
                  {transcript?.data.contributors.map((p: string) => (
                    <span class="text-sm font-serif bg-white px-3 py-1 rounded-md border border-[#2d2a26]/5 shadow-sm">
                      {p}
                    </span>
                  ))}
                </div>
              </div>
            )}
            <div class="transcript-content">
              <TranscriptContent />
            </div>
          </div>
        )
      }
    </section>
  </article>
</MainLayout>

<script define:vars={{ episode, formattedDate, downloadMetaDateLabel: site.pages.episodeDetail.downloadMetaDateLabel, downloadMetaAudioLabel: site.pages.episodeDetail.downloadMetaAudioLabel }}>
  // Tab Switching Logic
  function initTabs(pageRoot) {
    const tabs = pageRoot.querySelectorAll(".tab-btn");
    let isAnimating = false;
    const TRANSITION_MS = 300;

    const setActiveTab = (activeTab) => {
      tabs.forEach((t) => {
        t.classList.remove("active", "text-orange-700", "opacity-100");
        if (!t.hasAttribute("disabled")) {
          t.classList.add("opacity-40");
        }
      });
      activeTab.classList.remove("opacity-40");
      activeTab.classList.add("active", "text-orange-700", "opacity-100");
    };

    const swapPanels = (currentPanel, targetPanel) => {
      // Fade out current
      currentPanel.style.opacity = "0";
      setTimeout(() => {
        currentPanel.classList.add("hidden");

        // Prepare target
        targetPanel.classList.remove("hidden");
        // Force reflow
        void targetPanel.offsetWidth;

        // Fade in target
        targetPanel.style.opacity = "1";
        setTimeout(() => {
          isAnimating = false;
        }, TRANSITION_MS);
      }, TRANSITION_MS);
    };

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        if (tab.disabled || isAnimating) return;
        if (tab.classList.contains("active")) return;

        const targetId = tab.dataset.target;
        const targetPanel = pageRoot.querySelector(
          `#panel-${targetId}`,
        );
        const currentPanel = pageRoot.querySelector(".tab-panel:not(.hidden)");

        if (!targetPanel || targetPanel === currentPanel) return;

        isAnimating = true;

        // Update Tab Styles
        setActiveTab(tab);

        // Transition Logic
        if (currentPanel) {
          swapPanels(currentPanel, targetPanel);
        } else {
          // Fallback for initial state quirks
          targetPanel.classList.remove("hidden");
          void targetPanel.offsetWidth;
          targetPanel.style.opacity = "1";
          isAnimating = false;
        }
      });
    });
  }

  function initTimestampLinks() {
    const contentAreas = document.querySelectorAll(
      ".episode-content, .transcript-content",
    );
    if (!contentAreas.length) return;

    const TIMESTAMP_PATTERN = /(\d{1,2}:\d{2}(?::\d{2})?)/g;
    const parseTimeToSeconds = (timeStr) => {
      const parts = timeStr.split(":").map(Number);
      if (parts.length === 3) {
        return parts[0] * 3600 + parts[1] * 60 + parts[2];
      } else if (parts.length === 2) {
        return parts[0] * 60 + parts[1];
      }
      return 0;
    };

    contentAreas.forEach((area) => {
      if (area.dataset.processed) return;

      const audioUrl = encodeURIComponent(episode.enclosure?.url || "");
      const coverUrl = encodeURIComponent(episode.itunes?.image || "");
      const content = area.innerHTML;
      const processedContent = content.replace(
        TIMESTAMP_PATTERN,
        (match) => {
          const seconds = parseTimeToSeconds(match);
          return `<button type="button" class="timestamp-link" data-seconds="${seconds}" data-audio="${audioUrl}" data-cover="${coverUrl}">${match}</button>`;
        },
      );
      area.innerHTML = processedContent;
      area.dataset.processed = "true";
    });

    const body = document.body;
    if (!body) return;
    if (body.dataset.timestampBound) return;
    body.dataset.timestampBound = "true";

    document.addEventListener("click", (e) => {
      const target = e.target.closest(".timestamp-link");
      if (!target) return;
      const seconds = Number(target.dataset.seconds);
      if (!Number.isFinite(seconds)) return;
      const audioUrl = decodeURIComponent(
        target.dataset.audio || "",
      );
      if (!audioUrl) return;
      const cover = decodeURIComponent(
        target.dataset.cover || "",
      );

      if (typeof window.seekToTimestamp === "function") {
        window.seekToTimestamp(seconds, audioUrl, "", cover);
      }
    });
  }

  function initDownload() {
    const downloadBtn = document.getElementById("download-md");
    if (!downloadBtn || !window.episodeData?.transcript) return;

    const buildMarkdown = () => {
      const { episode, formattedDate, transcript } = window.episodeData;
      let mdContent = `# ${episode.title}\n\n`;
      mdContent += `> **${downloadMetaDateLabel}**: ${formattedDate}\n`;
      mdContent += `> **${downloadMetaAudioLabel}**: ${episode.enclosure?.url}\n\n`;
      mdContent += `---\n\n`;
      mdContent += transcript.body;
      return mdContent;
    };

    downloadBtn.addEventListener("click", () => {
      const blob = new Blob([buildMarkdown()], { type: "text/markdown" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${episode.title}.md`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  }

  function fitEpisodeTitle() {
    const title = document.querySelector("[data-fit-title]");
    const content = document.querySelector("[data-fit-content]");
    const cover = document.querySelector("[data-fit-cover]");
    if (!title || !content) return;

    title.style.removeProperty("font-size");

    if (!cover || cover.offsetParent === null) return;

    let computed = window.getComputedStyle(title);
    let fontSize = parseFloat(computed.fontSize);
    const minScale = parseFloat(title.dataset.minScale || "0.75");
    const minFont = parseFloat(title.dataset.minFont || "16");
    const minFontSize = Math.max(fontSize * minScale, minFont);

    const fits = () => content.scrollHeight <= content.clientHeight + 1;

    while (!fits() && fontSize > minFontSize) {
      fontSize -= 1;
      title.style.fontSize = `${fontSize}px`;
      computed = window.getComputedStyle(title);
    }
  }

  let resizeTimer;
  function handleTitleResize() {
    if (resizeTimer) window.clearTimeout(resizeTimer);
    resizeTimer = window.setTimeout(() => {
      fitEpisodeTitle();
    }, 120);
  }

  function initTitleFit() {
    fitEpisodeTitle();
    if ("fonts" in document && document.fonts && document.fonts.ready) {
      document.fonts.ready
        .then(() => {
          fitEpisodeTitle();
        })
        .catch(() => {});
    }
    window.removeEventListener("resize", handleTitleResize);
    window.addEventListener("resize", handleTitleResize, { passive: true });
  }

  function initEpisodePage() {
    const pageRoot = document.querySelector("[data-episode-page]");
    if (!pageRoot || pageRoot.dataset.bound === "true") return;
    pageRoot.dataset.bound = "true";

    initTabs(pageRoot);
    initDownload();
    initTimestampLinks();
    initTitleFit();
  }

  const scheduleInit = () => {
    requestAnimationFrame(() => initEpisodePage());
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", scheduleInit);
  } else {
    scheduleInit();
  }

  document.addEventListener("astro:page-load", scheduleInit);

  document.addEventListener("astro:before-swap", () => {
    window.removeEventListener("resize", handleTitleResize);
  });
</script>

<style is:global>
  .episode-content h2,
  .transcript-content h2 {
    font-size: 1.5rem;
    margin-top: 2.5rem;
    margin-bottom: 1.25rem;
    font-weight: bold;
    color: #2d2a26;
  }
  .episode-content p,
  .transcript-content p {
    margin-bottom: 1.5rem;
    line-height: 1.8;
  }
  .episode-content a,
  .transcript-content a {
    color: #c2410c;
    text-decoration: underline;
    text-underline-offset: 4px;
    font-weight: 500;
  }
  .episode-content figure,
  .transcript-content figure {
    margin: 2.5rem 0;
  }
  .episode-content img,
  .transcript-content img {
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    max-width: 100%;
    height: auto;
  }
  .episode-content ul,
  .transcript-content ul,
  .episode-content ol,
  .transcript-content ol {
    margin-bottom: 1.5rem;
    padding-left: 1.5rem;
  }
  .episode-content li,
  .transcript-content li {
    margin-bottom: 0.5rem;
  }
  .timestamp-link {
    color: #c2410c;
    font-weight: 500;
    cursor: pointer;
    border: 0;
    padding: 0.125rem 0.375rem;
    margin: 0 0.125rem;
    border-radius: 0.25rem;
    background: rgba(193, 65, 12, 0.08);
    transition: all 0.2s ease;
    text-decoration: none !important;
    display: inline-block;
    font: inherit;
  }
  .timestamp-link:hover {
    background: rgba(193, 65, 12, 0.2);
    color: #9a3412;
  }
  .timestamp-link:focus-visible {
    outline: 2px solid #c2410c;
    outline-offset: 2px;
  }

  /* Transcript specific styles */
  .transcript-content strong {
    color: #7c2d12;
    font-weight: 700;
    background: #fff7ed;
    padding: 0 4px;
    border-radius: 4px;
    margin-right: 4px;
  }

  .transcript-content blockquote {
    font-style: italic;
    color: #78716c;
    border-left: 3px solid #e7e5e4;
    padding-left: 1rem;
    margin: 1.5rem 0;
  }
</style>

<script define:vars={{ episode, formattedDate, transcript }}>
  window.episodeData = { episode, formattedDate, transcript };
</script>
