---
import MainLayout from "../layouts/MainLayout.astro";
import EpisodeCard from "../components/EpisodeCard.astro";
import themesData from "../data/themes.json";
import episodes from "../data/episodes.json";
// 页面标题与空状态文案在 site.json 中配置。
import site from "../data/site.json";

// 主题类型定义
type Theme = {
  id: string;
  title: string;
  description: string;
  representativeTags?: string[];
};

// AI 功能关闭时返回 404
const aiEnabled = site.features?.aiTagging === true;
if (!aiEnabled) {
  return new Response(null, { status: 404, statusText: "Not Found" });
}

// 类型断言
const themes = themesData as Theme[];

// 为每个主题计算节目数量
const themesWithCount = themes.map((theme) => ({
  ...theme,
  count: episodes.filter((ep) => ep.themeId === theme.id).length,
}));
---

<MainLayout title={site.pages.themes.title}>
  <div class="max-w-7xl mx-auto">
    <h1
      class="text-3xl md:text-4xl font-bold mb-12 text-center tracking-tight text-[#2d2a26]"
    >
      <span class="relative inline-block">
        {site.pages.themes.headline}
        <span
          class="absolute -bottom-3 left-1/2 -translate-x-1/2 w-12 h-1 bg-orange-700/20 rounded-full"
        ></span>
      </span>
    </h1>

    <!-- 主题选择器 -->
    <div class="flex flex-wrap justify-center gap-3 mb-12">
      {
        themesWithCount.map((theme, index) => (
          <button
            class:list={[
              "theme-tab px-4 py-2 md:px-6 md:py-3 rounded-full font-serif text-sm md:text-base transition-all duration-300 border",
              index === 0
                ? "bg-[#2d2a26] text-white border-[#2d2a26]"
                : "bg-white text-[#2d2a26] border-[#2d2a26]/10 hover:border-[#2d2a26]/30",
            ]}
            data-theme-id={theme.id}
          >
            <span class="font-bold">{theme.title}</span>
            <span class="ml-1.5 opacity-60">({theme.count})</span>
          </button>
        ))
      }
    </div>

    <!-- 主题描述 -->
    <div class="mb-10 text-center">
      {
        themes.map((theme, index) => (
          <div
            class:list={[
              "theme-description transition-all duration-300",
              index === 0 ? "block" : "hidden",
            ]}
            data-theme-desc={theme.id}
          >
            <p class="text-lg font-serif opacity-60 max-w-2xl mx-auto leading-relaxed mb-4">
              {theme.description}
            </p>
            {theme.representativeTags &&
              theme.representativeTags.length > 0 && (
                <div class="flex flex-wrap justify-center gap-2">
                  {theme.representativeTags.map((tag) => (
                    <span class="text-xs font-serif px-3 py-1 bg-[#2d2a26]/5 text-[#2d2a26]/60 rounded-full">
                      #{tag}
                    </span>
                  ))}
                </div>
              )}
          </div>
        ))
      }
    </div>

    <!-- 节目列表 -->
    {
      themes.map((theme, index) => {
        const themeEpisodes = episodes.filter((ep) => ep.themeId === theme.id);

        return (
          <div
            class:list={[
              "theme-episodes transition-all duration-300",
              index === 0 ? "block" : "hidden",
            ]}
            data-theme-list={theme.id}
          >
            {themeEpisodes.length > 0 ? (
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {themeEpisodes.map((episode) => (
                  <EpisodeCard episode={episode} compact={true} />
                ))}
              </div>
            ) : (
              <div class="bg-white/50 border border-[#2d2a26]/5 border-dashed rounded-xl p-12 text-center">
                <p class="text-lg opacity-40 font-serif">{site.pages.themes.emptyLabel}</p>
              </div>
            )}
          </div>
        );
      })
    }
  </div>
</MainLayout>

<script>
  function initThemeTabs() {
    const tabs = document.querySelectorAll(".theme-tab");
    const descriptions = document.querySelectorAll(".theme-description");
    const episodeLists = document.querySelectorAll(".theme-episodes");

    // 样式常量
    const ACTIVE_TAB = ["bg-[#2d2a26]", "text-white", "border-[#2d2a26]"];
    const INACTIVE_TAB = ["bg-white", "text-[#2d2a26]", "border-[#2d2a26]/10"];

    // 辅助函数：根据 data 属性切换元素显示
    function showByAttribute(
      elements: NodeListOf<Element>,
      attrName: string,
      targetValue: string | null,
    ) {
      elements.forEach((el) => {
        const isMatch = el.getAttribute(attrName) === targetValue;
        el.classList.toggle("hidden", !isMatch);
        el.classList.toggle("block", isMatch);
      });
    }

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        const themeId = tab.getAttribute("data-theme-id");

        // 更新 tab 样式
        tabs.forEach((t) => {
          t.classList.remove(...ACTIVE_TAB);
          t.classList.add(...INACTIVE_TAB);
        });
        tab.classList.remove(...INACTIVE_TAB);
        tab.classList.add(...ACTIVE_TAB);

        // 切换描述和节目列表
        showByAttribute(descriptions, "data-theme-desc", themeId);
        showByAttribute(episodeLists, "data-theme-list", themeId);

        requestAnimationFrame(() => {
          window.dispatchEvent(new Event("episode-card:fit"));
        });
      });
    });
  }

  document.addEventListener("astro:page-load", initThemeTabs);
</script>
